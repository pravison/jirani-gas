{% extends 'main.html' %}
{% load humanize %}
{% load static %}
{% block title %}affordable gas refil around nairobi {% endblock%}
{% block keyword %} total gas, afrigas, pro gas, taifa gas, k-gas, supa gas, mpishi gas, midgas,   {% endblock %}
{% block description %} affordable gas , accessories, and refills {% endblock %}
{% block content %}


<section class="flat-filter-search-v2">
    <div class="flat-tab flat-tab-form">
        
        <div class="tab-content">
            <div class="tab-pane fade active show" role="tabpanel">
                <div class="form-sl">
                    <form method="post" action="{% url 'e_store' %}?query={{request.build_absolute_uri}}">
                        {% csrf_token %}
                        <div class="wd-find-select">
                            <div class="inner-group">
                                <div class="form-group-1 search-form form-style">
                                    <input type="text" class="form-control" placeholder="Search keyword." id="keyword-query" value="" name="keyword" title="Search for" >
                                    <a href="#" class="icon icon-search" id="keyword-query-icon">
                                    </a>
                                    </div>
                                <div class="form-group-2 form-style">
                                    <div class="group-ip">
                                        <input type="text" class="form-control" placeholder="Search Location" id="location-query" value="" name="location" title="Search for" >
                                        <a href="#" class="icon icon-location" id="location-query-icon"></a>
                                    </div>
                                </div>

                                <div class="form-group-2 form-style">
                                    <div class="group-select">
                                        <select class="nice-select" name="category" tabindex="0"><span class="current">Select Category</span>
                                            <option value="" class="option form-control selected">Select Category</option>
                                                {% for category in categories %}
                                                <option value="{{category.name}}" class="option">{{ category.name }}</option>
                                                {% endfor %}
    
    
                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="box-btn-advanced">
                                <button type="submit" class="tf-btn btn-line btn-search">Search <i class="icon icon-search"></i> </button>
                            </div>

                        </div>
                        <div class="wd-search-form">
                            <div class="grid-2 group-box group-price">
                                <div class="box-title-price">
                                    <span class="title-price fw-6">Listing Type:</span>
                                
                                <div class="group-select">
                                    <select class="nice-select" name="appartment_type" tabindex="0"><span class="current">All</span>
                                        <option value="" class="option form-control selected">All</option>
                                            {% for listing_type in listing_types %}
                                            <option value="{{listing_type.name}}" class="option">{{ listing_type.name }}</option>
                                            {% endfor %}


                                    </select>
                                </div>
                                
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</section>



<section class="wrapper-layout layout-2">
    <div class="wrap-left">
        <div class="box-title-listing">
            <h3 class="fw-8">Our Catalogue</h3>
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>


                {% endfor %}
            {% endif %}
            <div class="box-filter-tab">
                <ul class="nav-tab-filter" role="tablist">
                    <li class="nav-tab-item" role="presentation">
                        <a href="#gridLayout" class="nav-link-item active" data-bs-toggle="tab">
                            <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4.54883 5.90508C4.54883 5.1222 5.17272 4.5 5.91981 4.5C6.66686 4.5 7.2908 5.12221 7.2908 5.90508C7.2908 6.68801 6.66722 7.3101 5.91981 7.3101C5.17241 7.3101 4.54883 6.68801 4.54883 5.90508Z" stroke="#A3ABB0"/>
                                <path d="M10.6045 5.90508C10.6045 5.12221 11.2284 4.5 11.9755 4.5C12.7229 4.5 13.3466 5.1222 13.3466 5.90508C13.3466 6.68789 12.7227 7.3101 11.9755 7.3101C11.2284 7.3101 10.6045 6.68794 10.6045 5.90508Z" stroke="#A3ABB0"/>
                                <path d="M19.4998 5.90514C19.4998 6.68797 18.8757 7.31016 18.1288 7.31016C17.3818 7.31016 16.7578 6.68794 16.7578 5.90508C16.7578 5.12211 17.3813 4.5 18.1288 4.5C18.8763 4.5 19.4998 5.12215 19.4998 5.90514Z" stroke="#A3ABB0"/>
                                <path d="M7.24249 12.0098C7.24249 12.7927 6.61849 13.4148 5.87133 13.4148C5.12411 13.4148 4.5 12.7926 4.5 12.0098C4.5 11.2268 5.12419 10.6045 5.87133 10.6045C6.61842 10.6045 7.24249 11.2267 7.24249 12.0098Z" stroke="#A3ABB0"/>
                                <path d="M13.2976 12.0098C13.2976 12.7927 12.6736 13.4148 11.9266 13.4148C11.1795 13.4148 10.5557 12.7928 10.5557 12.0098C10.5557 11.2266 11.1793 10.6045 11.9266 10.6045C12.6741 10.6045 13.2976 11.2265 13.2976 12.0098Z" stroke="#A3ABB0"/>
                                <path d="M19.4516 12.0098C19.4516 12.7928 18.828 13.4148 18.0807 13.4148C17.3329 13.4148 16.709 12.7926 16.709 12.0098C16.709 11.2268 17.3332 10.6045 18.0807 10.6045C18.8279 10.6045 19.4516 11.2266 19.4516 12.0098Z" stroke="#A3ABB0"/>
                                <path d="M4.54297 18.0945C4.54297 17.3116 5.16709 16.6895 5.9143 16.6895C6.66137 16.6895 7.28523 17.3114 7.28523 18.0945C7.28523 18.8776 6.66139 19.4996 5.9143 19.4996C5.16714 19.4996 4.54297 18.8771 4.54297 18.0945Z" stroke="#A3ABB0"/>
                                <path d="M10.5986 18.0945C10.5986 17.3116 11.2227 16.6895 11.97 16.6895C12.7169 16.6895 13.3409 17.3115 13.3409 18.0945C13.3409 18.8776 12.7169 19.4996 11.97 19.4996C11.2225 19.4996 10.5986 18.8772 10.5986 18.0945Z" stroke="#A3ABB0"/>
                                <path d="M16.752 18.0945C16.752 17.3115 17.376 16.6895 18.1229 16.6895C18.8699 16.6895 19.4939 17.3115 19.4939 18.0945C19.4939 18.8776 18.8702 19.4996 18.1229 19.4996C17.376 19.4996 16.752 18.8772 16.752 18.0945Z" stroke="#A3ABB0"/>
                            </svg>
                                
                        </a>
                    </li>
                    
                    <li class="nav-tab-item"><a href="#" class="nav-link-item" onclick="showPopup(event)">
                            <svg class="icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.41251 8.18022C5.23091 7.85345 4.94594 7.59624 4.60234 7.44895C4.25874 7.30167 3.87596 7.27265 3.51408 7.36645C3.1522 7.46025 2.83171 7.67157 2.60293 7.96722C2.37414 8.26287 2.25 8.62613 2.25 8.99997C2.25 9.37381 2.37414 9.73706 2.60293 10.0327C2.83171 10.3284 3.1522 10.5397 3.51408 10.6335C3.87596 10.7273 4.25874 10.6983 4.60234 10.551C4.94594 10.4037 5.23091 10.1465 5.41251 9.81972M5.41251 8.18022C5.54751 8.42322 5.62476 8.70222 5.62476 8.99997C5.62476 9.29772 5.54751 9.57747 5.41251 9.81972M5.41251 8.18022L12.587 4.19472M5.41251 9.81972L12.587 13.8052M12.587 4.19472C12.6922 4.39282 12.8358 4.56797 13.0095 4.70991C13.1832 4.85186 13.3834 4.95776 13.5985 5.02143C13.8135 5.08509 14.0392 5.10523 14.2621 5.08069C14.4851 5.05614 14.7009 4.98739 14.897 4.87846C15.093 4.76953 15.2654 4.62261 15.404 4.44628C15.5427 4.26995 15.6448 4.06775 15.7043 3.85151C15.7639 3.63526 15.7798 3.40931 15.751 3.18686C15.7222 2.96442 15.6494 2.74994 15.5368 2.55597C15.3148 2.17372 14.9518 1.89382 14.5256 1.77643C14.0995 1.65904 13.6443 1.71352 13.2579 1.92818C12.8715 2.14284 12.5848 2.50053 12.4593 2.92436C12.3339 3.34819 12.3797 3.80433 12.587 4.19472ZM12.587 13.8052C12.4794 13.999 12.4109 14.2121 12.3856 14.4323C12.3603 14.6525 12.3787 14.8756 12.4396 15.0887C12.5005 15.3019 12.6028 15.5009 12.7406 15.6746C12.8784 15.8482 13.0491 15.9929 13.2429 16.1006C13.4367 16.2082 13.6498 16.2767 13.87 16.302C14.0902 16.3273 14.3133 16.3089 14.5264 16.248C14.7396 16.1871 14.9386 16.0848 15.1122 15.947C15.2858 15.8092 15.4306 15.6385 15.5383 15.4447C15.7557 15.0534 15.8087 14.5917 15.6857 14.1612C15.5627 13.7307 15.2737 13.3668 14.8824 13.1493C14.491 12.9319 14.0293 12.8789 13.5989 13.0019C13.1684 13.1249 12.8044 13.4139 12.587 13.8052Z" stroke="#A3ABB0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                        <a href="#" class="nav-link-item">
                            <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L6 18" stroke="#A3ABB0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M6 6L18 18" stroke="#A3ABB0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                    </li>
                    <!-- SVG Element -->
                    <li class="nav-tab-item">
                        
                    </li>
                </ul>
                
            </div>
        </div>
        <div class="flat-animate-tab">
            
            <button class="btn btn-danger" id="cart-icon" class="cart-icon" style="display: flex; position: fixed; right: 10%; top: 8%; z-index: 1060;"><span class="quantity" id="cart" style="color: aliceblue;">0</span></button>
            <div id="cart-sidebar" class="cart-sidebar">
                <div class="cart-header">
                    <h2>Your Cart</h2>
                    <button class="btn btn-danger" id="sidebar-cart-icon" class="cart-icon"><span class="quantity" id="sidebar-cart" style="color: aliceblue;">0</span></button>
            
                    <span id="close-cart-sidebar">&times;</span>
                </div>
                <div class="cart-container">
                    <!-- Cart items will be rendered dynamically here -->
                </div>
                <div class="cart-footer">
                    <div class="total">
                        <span>Total:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                    <a href="#" class="checkout-button">Checkout</a>
                </div>
            </div>
            <div class="tab-content">
                <div class="tab-pane active show" id="gridLayout" role="tabpanel">
                    <div class="row">
                        {% for  product in retail_products %}
                        <div class="col-md-4">
                            <div class="homelengo-box">
                                {% if product.product.quantity <= 0 %}
                                <div class="diagonal-strip">SOLD OUT</div>
                                {% endif %}
                                <div class="archive-top">
                                    <a href="#" class="images-group">
                                        <div class="images-style" >
                                            {% with product.product.images.all|first as first_image %}
                                            <img class="lazyload" data-src="{{ first_image.imageURL }}" src="{{ first_image.imageURL}}" alt="img">                                              
                                            {% endwith %}
                                        </div>
                                        <div class="top">
                                            <ul class="d-flex gap-6">
                                                <li class="flag-tag   primary ">{{product.product.category}}</li>
                                            </ul>
                                        </div>
                                        <div class="bottom">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="..." stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg> {{ listing.property_address }}, {{ listing.location.location }}
                                        </div>
                                    </a>
                                </div>
                                <div class="archive-bottom">
                                    <div class="content-top">
                                        <h6 class="text-capitalize"><a href="#" class="link"> {{ product.product.name }}</a></h6>
                                        {% if product.description %}
                                        <p>{{product.description|safe|truncatechars:100}}</p>
                                        {% elif product.product.description %}
                                        <p>{{product.product.description|safe|truncatechars:100}}</p>
                                        {% endif %}
                                        <ul class="meta-list">
                                            <li class="item">
                                                <span class="text-variant-1">Quantity:</span>
                                                <span class="fw-6">{{ product.product.quantity}}</span>
                                            </li>
                                        </ul>

                                    </div>

                                    <div class="content-bottom">
                                        <div class="d-flex gap-8 align-items-center" id="product-{{ product.id }}">
                                            <!-- Add to Cart Button -->
                                            <span class="add-to-cart-btn" onclick="addToCart('{{ product.id }}', '{{ product.product.name }}', '{{ product.product.images.first.image.url }}', '{{ product.retail_price }}', '{{product.product.quantity }}')">
                                                Add to Cart
                                            </span>
                                        
                                            <!-- Quantity Display with Plus and Minus Buttons -->
                                            <span class="cart-quantity" style="display: none;">
                                                <button class="quantity-btn minus" onclick="removeFromCart('{{ product.id }}')">-</button>
                                                <span class="quantity" id="quantity-{{ product.id }}">0</span>
                                                <button class="quantity-btn plus" onclick="addToCart('{{ product.id }}', '{{ product.product.name }}', '{{ product.product.images.first.url }}', '{{ product.price }}', '{{product.product.quantity }}')">+</button>
                                            </span>
                                        </div>
                                        
                                        <h6 class="price">Ksh. {{product.retail_price|intcomma}}</h6>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                    </div>

                </div>
            </div>
        </div>
    </div>
   
</section>


<!-- lcation search script -->
<script>
    document.getElementById('location-query-icon').addEventListener('click', function (event) {
        event.preventDefault(); // Prevent default action of the link
        const location = document.getElementById('location-query').value;
        if (location) {
            const baseUrl = "#"; // Use Django's url template tag
            window.location.href = `${baseUrl}?location=${encodeURIComponent(location)}`;
        } else {
            alert('Please enter location to search.');
        }
    });
</script>

<!-- keyword search script -->
<script>
    document.getElementById('keyword-query-icon').addEventListener('click', function (event) {
        event.preventDefault(); // Prevent default action of the link
        const keyword = document.getElementById('keyword-query').value;
        if (keyword) {
            const baseUrl = "#"; // Use Django's url template tag
            window.location.href = `${baseUrl}?keyword=${encodeURIComponent(keyword)}`;
        } else {
            alert('Please enter keyword you want to search.');
        }
    });
</script>


<!-- Popup Modal -->
<div id="popup" class="popup">
    <div class="popup-content">
        <p>Share this URL:</p>
        <input type="text" id="share-url" value="{{request.build_absolute_uri}}" readonly />
        <button onclick="copyToClipboard()">Copy</button>
        <button onclick="closePopup()">Close</button>
    </div>
</div>
<script>
    function showPopup(event) {
        event.preventDefault(); // Prevent default link behavior
        const popup = document.getElementById('popup');
        popup.style.display = 'flex'; // Show the popup
    }
    
    function closePopup() {
        const popup = document.getElementById('popup');
        popup.style.display = 'none'; // Hide the popup
    }
    
    function copyToClipboard() {
        const urlField = document.getElementById('share-url');
        urlField.select(); // Select the text
        document.execCommand('copy'); // Copy the text to the clipboard
        alert('URL copied to clipboard!');
    }
</script>

<script>
    // Get the store slug from the URL or other means
    const storeSlug = "{{ client.slug }}"; // Assumes URL format: /store-slug/
    const cartKey = `cart_${storeSlug}`; // Unique key for each store's cart
    let cart = JSON.parse(localStorage.getItem(cartKey)) || { cartItems: {} };


    // Function to update the UI for a single product.
    function updateCartUI(productId) {
        const productElement = document.getElementById(`product-${productId}`);
        const addToCartBtn = productElement.querySelector('.add-to-cart-btn');
        const cartQuantity = productElement.querySelector('.cart-quantity');
        const quantity = productElement.querySelector('.quantity');

        if (cart.cartItems[productId]) {
            // Show quantity controls and hide the "Add to Cart" button.
            addToCartBtn.style.display = 'none';
            cartQuantity.style.display = 'flex';
            quantity.textContent = cart.cartItems[productId].cartQuantity;
        } else {
            // Show the "Add to Cart" button and hide quantity controls.
            addToCartBtn.style.display = 'inline-block';
            cartQuantity.style.display = 'none';
        }
    }

    // Function to calculate and update total quantity and price
    function updateCartSummary() {
        let totalQuantity = 0;
        let totalPrice = 0;

        for (const productId in cart.cartItems) {
            const product = cart.cartItems[productId];
            totalQuantity += product.cartQuantity; // Sum up all product quantities
            totalPrice += product.price * product.cartQuantity; // Calculate total price
        }

        // Update the UI
        document.getElementById('cart').textContent = totalQuantity;
        document.getElementById('sidebar-cart').textContent = totalQuantity;
        document.getElementById('cart-total').textContent = `$${totalPrice.toFixed(2)}`;
    }

    // Function to handle adding the product to the cart.
    function addToCart(productId, productName, productImage, productPrice, productQuantity) {
        if (!cart.cartItems[productId]) {
            cart.cartItems[productId] = {
                id: productId,
                name: productName,
                image: productImage,
                price: productPrice,
                availableQuantity: productQuantity,
                cartQuantity: 1,
            };
        } else if (cart.cartItems[productId].cartQuantity < cart.cartItems[productId].availableQuantity) {
            cart.cartItems[productId].cartQuantity++;
        } else {
            alert("You cannot add more than the available quantity.");
            return;
        }

        localStorage.setItem(cartKey, JSON.stringify(cart));
        updateCartUI(productId); // Update the UI after adding.
        updateCartSummary();
        renderCartSidebar();
    }

    // Function to handle removing the product from the cart.
    function removeFromCart(productId) {
        if (cart.cartItems[productId]) {
            if (cart.cartItems[productId].cartQuantity > 1) {
                cart.cartItems[productId].cartQuantity--;
            } else {
                delete cart.cartItems[productId];
            }

            localStorage.setItem(cartKey, JSON.stringify(cart));
            updateCartUI(productId); // Update the UI after removing.
            updateCartSummary();
            renderCartSidebar();
        }
    }

    // Function to render the cart page with product details in the sidebar.
    function renderCartSidebar() {
        const cartContainer = document.querySelector('.cart-container');
        cartContainer.innerHTML = ''; // Clear previous items
        let total = 0;

        for (const productId in cart.cartItems) {
            const product = cart.cartItems[productId];
            const totalPrice = product.price * product.cartQuantity;
            total += totalPrice;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="cart-item-image">
                <div class="cart-item-details">
                    <h4>${product.name}</h4>
                    <p>Price: ${product.price.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                    <div class="cart-item-quantity">
                        <button onclick="removeFromCart('${product.id}')">-</button>
                        <span> ${product.cartQuantity}</span>
                        <button onclick="addToCart('${product.id}', '${product.name}', '${product.image}', '${product.price}', '${product.availableQuantity}')">+</button>
                    </div>
                    <p>Total: Ksh.${totalPrice.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                </div>
            `;
            cartContainer.appendChild(cartItem);
        }

        // Update the total in the sidebar.
        document.getElementById('cart-total').textContent = `Ksh.${total.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Update the UI for the product when the page loads.
    document.addEventListener('DOMContentLoaded', function () {
        // Update total quantity and total price on page load.
        updateCartSummary();
        const productIds = Object.keys(cart.cartItems);
        productIds.forEach(productId => updateCartUI(productId));

        // Render the cart in the sidebar if available.
        if (document.querySelector('.cart-container')) {
            renderCartSidebar();
        }
    });

    // Cart sidebar open/close event listeners.
    document.getElementById('cart-icon').addEventListener('click', function () {
        const sidebar = document.getElementById('cart-sidebar');
        sidebar.classList.add('open');
        renderCartSidebar(); // Dynamically render cart content
    });

    document.getElementById('close-cart-sidebar').addEventListener('click', function () {
        const sidebar = document.getElementById('cart-sidebar');
        sidebar.classList.remove('open');
    });

    // Send cart data to the backend when the browser is about to close.
    // window.addEventListener('beforeunload', function () {
    //     if (Object.keys(cart.cartItems).length > 0) {
    //         fetch("", {
    //             method: "POST",
    //             headers: {
    //                 "Content-Type": "application/json",
    //                 "X-CSRFToken": "{{ csrf_token }}",
    //             },
    //             body: JSON.stringify({ cart }),
    //         }).then(response => {
    //             if (response.ok) {
    //                 console.log("Cart sent to the backend successfully.");
    //             }
    //         }).catch(error => {
    //             console.error("Error sending cart to backend:", error);
    //         });
    //     }
    // });
</script>


<!-- <script>
    // Initialize the cart from localStorage or as an empty object.
    let cart = JSON.parse(localStorage.getItem('cart')) || {};
    
    // Function to update the UI for a single product.
    function updateCartUI(productId) {
        const productElement = document.getElementById(`product-${productId}`);
        const addToCartBtn = productElement.querySelector('.add-to-cart-btn');
        const cartQuantity = productElement.querySelector('.cart-quantity');
        const quantity = productElement.querySelector('.quantity');
    
        if (cart[productId]) {
            // Show quantity controls and hide the "Add to Cart" button.
            addToCartBtn.style.display = 'none';
            cartQuantity.style.display = 'flex';
            quantity.textContent = cart[productId].cartQuantity;
        } else {
            // Show the "Add to Cart" button and hide quantity controls.
            addToCartBtn.style.display = 'inline-block';
            cartQuantity.style.display = 'none';
        }
    }

    // Function to calculate and update total quantity and price
    function updateCartSummary() {
        let totalQuantity = 0;
        let totalPrice = 0;

        for (const productId in cart) {
            const product = cart[productId];
            totalQuantity += product.cartQuantity; // Sum up all product quantities
            totalPrice += product.price * product.cartQuantity; // Calculate total price
        }

        // Update the UI
        document.getElementById('cart').textContent = totalQuantity;
        document.getElementById('sidebar-cart').textContent = totalQuantity;
        document.getElementById('cart-total').textContent = `$${totalPrice.toFixed(2)}`;
    }

    
    // Function to handle adding the product to the cart.
    function addToCart(productId, productName, productImage, productPrice, productQuantity) {
        if (!cart[productId]) {
            cart[productId] = {
                name: productName,
                image: productImage,
                price: productPrice,
                availableQuantity: productQuantity,
                cartQuantity: 1,
            };
        } else if (cart[productId].cartQuantity < cart[productId].availableQuantity) {
            cart[productId].cartQuantity++;
        } else {
            alert("You cannot add more than the available quantity.");
            return;
        }
    
        localStorage.setItem('cart', JSON.stringify(cart)); // Save cart to localStorage.
        updateCartUI(productId); // Update the UI after adding.
        updateCartSummary();
        renderCartSidebar();
    }
    
    // Function to handle removing the product from the cart.
    function removeFromCart(productId) {
        if (cart[productId]) {
            if (cart[productId].cartQuantity > 1) {
                cart[productId].cartQuantity--;
            } else {
                delete cart[productId];
            }
    
            localStorage.setItem('cart', JSON.stringify(cart)); // Save cart to localStorage.
            updateCartUI(productId); // Update the UI after removing.
            updateCartSummary();
            renderCartSidebar();
        }
    }

    
    // Function to render the cart page with product details in the sidebar.
    function renderCartSidebar() {
        const cartContainer = document.querySelector('.cart-container');
        cartContainer.innerHTML = ''; // Clear previous items
        let total = 0;

        for (const productId in cart) {
            const product = cart[productId];
            const totalPrice = product.price * product.cartQuantity;
            total += totalPrice;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="cart-item-image">
                <div class="cart-item-details">
                    <h4>${product.name}</h4>
                    <p>Price: ${product.price.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                    <div class="cart-item-quantity">
                        <button onclick="removeFromCart('${productId}')">-</button>
                        <span> ${product.cartQuantity}</span>
                        <button onclick="addToCart('${productId}', '${product.name}', '${product.image}', '${product.price}', '${product.availableQuantity}')">+</button>
                    </div>
                    <p>Total: Ksh.${totalPrice.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                </div>
            `;
            cartContainer.appendChild(cartItem);
        }

        // Update the total in the sidebar.
        document.getElementById('cart-total').textContent = `Ksh.${total.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Update the UI for the product when the page loads.
    document.addEventListener('DOMContentLoaded', function () {
        // Update total quantity and total price on page load.
        updateCartSummary();
        const productIds = Object.keys(cart);
        productIds.forEach(productId => updateCartUI(productId));
        
        // Render the cart in the sidebar if available.
        if (document.querySelector('.cart-container')) {
            renderCartSidebar();
        }
    });

    // Cart sidebar open/close event listeners.
    document.getElementById('cart-icon').addEventListener('click', function () {
        const sidebar = document.getElementById('cart-sidebar');
        sidebar.classList.add('open');
        renderCartSidebar(); // Dynamically render cart content
    });

    document.getElementById('close-cart-sidebar').addEventListener('click', function () {
        const sidebar = document.getElementById('cart-sidebar');
        sidebar.classList.remove('open');
    });
   

    // Send cart data to the backend when the browser is about to close.
    // window.addEventListener('beforeunload', function () {
    //     if (Object.keys(cart).length > 0) {
    //         fetch("", {
    //             method: "POST",
    //             headers: {
    //                 "Content-Type": "application/json",
    //                 "X-CSRFToken": "{{ csrf_token }}",
    //             },
    //             body: JSON.stringify({ cart }),
    //         }).then(response => {
    //             if (response.ok) {
    //                 console.log("Cart sent to the backend successfully.");
    //             }
    //         }).catch(error => {
    //             console.error("Error sending cart to backend:", error);
    //         });
    //     }
    // });
</script> -->

{% endblock %}

